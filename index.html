<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MicroSense ‚Äî Web AI Microplastic Detector</title>

<!-- TensorFlow.js (used only if model present) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0/dist/tf.min.js"></script>

<style>
  :root{
    --accent:#0077b6; --accent-2:#00b4d8; --bg:#eaf8ff; --card:#fff;
  }
  html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#023047}
  /* Splash */
  #splash{position:fixed;inset:0;background:linear-gradient(180deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff;z-index:1000}
  .slogo{width:110px;height:110px;border-radius:28px;background:#fff;display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:800;font-size:32px;box-shadow:0 10px 40px rgba(2,6,23,0.12)}
  .splash-text{margin-top:12px;font-size:18px}
  .hide-splash{animation:fade 0.8s ease 0.6s forwards}
  @keyframes fade{to{opacity:0;visibility:hidden;z-index:-1}}
  /* layout */
  .wrap{max-width:1100px;margin:56px auto;padding:18px}
  header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;color:white;font-weight:900}
  h1{margin:0;font-size:20px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.05)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#001;padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid rgba(2,6,23,0.06);padding:10px 12px;border-radius:10px;cursor:pointer}
  .main{display:grid;grid-template-columns:1fr 320px;gap:16px;margin-top:16px}
  .preview{background:#f7fbff;border-radius:10px;min-height:340px;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
  canvas{max-width:100%;height:auto;display:block}
  .right{display:flex;flex-direction:column;gap:12px}
  .small{font-size:13px;color:#445567}
  .mode-toggle{display:flex;gap:6px;flex-wrap:wrap}
  input[type=range]{width:100%}
  .meter-bg{height:14px;background:#eee;border-radius:30px;overflow:hidden}
  .meter-fill{height:100%;width:0%;background:linear-gradient(90deg,#ffb703,#fb5607);transition:width 900ms ease}
  footer{margin-top:18px;text-align:center;color:#7a8a96;font-size:13px}
  .history img{width:100%;border-radius:8px;margin-bottom:8px}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash">
  <div class="slogo">MS</div>
  <div class="splash-text">MicroSense ‚Äî AI Microplastic Detection</div>
</div>

<div class="wrap">
  <header>
    <div class="logo">üíß</div>
    <div><h1>MicroSense ‚Äî Web AI</h1><div class="small">Real-time microplastic segmentation (TensorFlow.js)</div></div>
  </header>

  <div class="card">
    <div class="controls">
      <input id="fileInput" type="file" accept="image/*" style="display:none">
      <button class="btn" id="chooseBtn">üìÅ Choose Image</button>
      <button class="btn" id="cameraBtn">üì∑ Camera</button>
      <button class="btn-ghost" id="runBtn">‚ñ∂ Run (model)</button>
      <div class="small" id="modelStatus">Model: checking‚Ä¶</div>
    </div>

    <div class="main" style="margin-top:12px">
      <div>
        <div class="preview card" id="previewBox">
          <canvas id="canvasOut" style="display:none"></canvas>
          <img id="previewImg" style="max-width:100%;display:none"/>
        </div>

        <div style="margin-top:10px" class="mode-toggle">
          <label class="small">Mask style:</label>
          <button class="btn-ghost maskBtn" data-style="red">Red</button>
          <button class="btn-ghost maskBtn" data-style="dual">Dual</button>
          <button class="btn-ghost maskBtn" data-style="heat">Heatmap</button>
          <button class="btn-ghost maskBtn" data-style="blend">Blended</button>
        </div>

        <div style="margin-top:10px">
          <label class="small">Threshold</label>
          <input id="threshold" type="range" min="0" max="100" value="50" />
        </div>
      </div>

      <div class="right">
        <div class="card small">
          <strong>Results</strong>
          <div id="meta" style="margin-top:8px">No image</div>
          <div id="info" style="margin-top:6px">Hybrid: model ‚Üí tfjs / fallback JS</div>
          <div id="stats" style="margin-top:6px">Particles(px): ‚Äî</div>
          <div style="margin-top:8px"><button class="btn" id="saveBtn">üíæ Save</button></div>
        </div>

        <div class="card">
          <strong class="small">Safety meter</strong>
          <div class="meter-bg" style="margin-top:10px"><div class="meter-fill" id="safetymeter"></div></div>
          <div class="small" style="margin-top:8px">Lower is safer</div>
        </div>

        <div class="card">
          <strong class="small">History</strong>
          <div class="history" id="history" style="margin-top:8px">No saved results</div>
        </div>
      </div>
    </div>
  </div>

  <footer>MicroSense ‚Ä¢ On-device AI ‚Ä¢ Works offline (if model cached)</footer>
</div>

<script>
/* ---------- App state ---------- */
const modelPath = 'models/model.json'; // place tfjs model here (see instructions)
let tfModel = null;
let lastMask = null;
let currentStyle = 'red';

/* Splash hide after short delay */
setTimeout(()=>{document.getElementById('splash').classList.add('hide-splash')},2600);

/* UI elements */
const fileInput = document.getElementById('fileInput');
const chooseBtn = document.getElementById('chooseBtn');
const cameraBtn = document.getElementById('cameraBtn');
const runBtn = document.getElementById('runBtn');
const previewImg = document.getElementById('previewImg');
const canvasOut = document.getElementById('canvasOut');
const threshold = document.getElementById('threshold');
const maskBtns = document.querySelectorAll('.maskBtn');
const modelStatus = document.getElementById('modelStatus');
const safetymeter = document.getElementById('safetymeter');
const meta = document.getElementById('meta');
const stats = document.getElementById('stats');
const historyDiv = document.getElementById('history');

/* setup */
chooseBtn.onclick = ()=> fileInput.click();
fileInput.onchange = e => { const f=e.target.files[0]; if(!f) return loadImage(URL.createObjectURL(f), f.name); };
maskBtns.forEach(b=>b.onclick = ()=> { currentStyle=b.dataset.style; maskBtns.forEach(x=>x.style.border='1px solid rgba(2,6,23,0.06)'); b.style.border='2px solid var(--accent)'; });

/* Load built-in tfjs model if present */
async function loadTfModel(){
  try{
    modelStatus.innerText = 'Model: loading‚Ä¶';
    tfModel = await tf.loadGraphModel(modelPath);
    modelStatus.innerText = 'Model: loaded (tfjs)';
  }catch(e){
    console.warn('No tfjs model found at',modelPath);
    modelStatus.innerText = 'Model: not found ‚Äî using fallback';
    tfModel = null;
  }
}
loadTfModel();

/* Camera capture */
cameraBtn.onclick = async ()=>{
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    const video = document.createElement('video'); video.autoplay=true; video.playsInline=true; video.srcObject=stream;
    await new Promise(r=>setTimeout(r,700));
    const w = video.videoWidth || 640, h = video.videoHeight || 480;
    const c = document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(video,0,0,w,h);
    const data = c.toDataURL('image/png'); loadImage(data,'camera');
    stream.getTracks().forEach(t=>t.stop());
  }catch(err){ alert('Camera not available: '+err.message); }
};

/* Load image into preview */
function loadImage(src, name){
  previewImg.onload = ()=>{ previewImg.style.display='block'; canvasOut.style.display='none'; meta.innerText = `File: ${name} ‚Ä¢ ${previewImg.naturalWidth}√ó${previewImg.naturalHeight}`; };
  previewImg.src = src;
}

/* Run segmentation pipeline */
runBtn.onclick = async ()=>{
  if(!previewImg.src) return alert('Upload an image first');
  const useModel = !!tfModel;
  if(useModel) {
    await runTfInference();
  } else {
    runHeuristic();
  }
};

/* Heuristic fallback (fast) */
function runHeuristic(){
  // simple random mask to demonstrate UI
  const size = 128;
  const mask = new Uint8Array(size*size);
  for(let i=0;i<mask.length;i++){ mask[i] = Math.random() < 0.04 ? 1 : 0; }
  lastMask = {width:size,height:size,data:mask};
  renderMask(lastMask);
  stats.innerText = 'Particles(px): approx '+mask.reduce((a,b)=>a+b,0);
  updateSafety(mask);
}

/* TFJS inference (expects model to output [1,H,W,1] probability map scaled [0,1]) */
async function runTfInference(){
  try{
    modelStatus.innerText = 'Model: running inference‚Ä¶';
    // prepare tensor from image
    // choose input size from model metadata if available; fallback 256
    const inputSize = (tfModel.inputs && tfModel.inputs.length && tfModel.inputs[0].shape[1]) ? tfModel.inputs[0].shape[1] : 256;
    const img = tf.browser.fromPixels(previewImg).toFloat().div(255.0).resizeBilinear([inputSize,inputSize]).expandDims(0);
    const out = await tfModel.predict(img);
    const probs = out.dataSync ? out.dataSync() : await out.data();
    // convert to mask
    const len = probs.length;
    const size = Math.round(Math.sqrt(len));
    const mask = new Uint8Array(size*size);
    const thr = parseInt(threshold.value)/100.0;
    for(let i=0;i<mask.length;i++){ mask[i] = probs[i] >= thr ? 1 : 0; }
    lastMask = {width:size,height:size,data:mask};
    renderMask(lastMask);
    stats.innerText = 'Particles(px): '+mask.reduce((a,b)=>a+b,0);
    updateSafety(mask);
    modelStatus.innerText = 'Model: done';
    tf.dispose([img,out]);
  }catch(err){
    console.error(err);
    modelStatus.innerText = 'Model error ‚Äî using fallback';
    runHeuristic();
  }
}

/* Render mask (overlay) */
function renderMask(maskObj){
  const canvas = canvasOut; const ctx = canvas.getContext('2d');
  const w = previewImg.naturalWidth, h = previewImg.naturalHeight;
  canvas.width = w; canvas.height = h;
  ctx.drawImage(previewImg,0,0,w,h);
  const mw = maskObj.width, mh = maskObj.height;
  const imgData = ctx.getImageData(0,0,w,h);
  const d = imgData.data;
  const thr = parseInt(threshold.value)/100.0;
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const mx = Math.floor(x * mw / w);
      const my = Math.floor(y * mh / h);
      const val = maskObj.data[my*mw + mx];
      const i = (y*w + x)*4;
      if(val===1){
        if(currentStyle==='red'){ d[i]=Math.min(255,d[i]+160); d[i+1]=Math.max(0,d[i+1]-80); d[i+2]=Math.max(0,d[i+2]-80); }
        else if(currentStyle==='dual'){ d[i]=200; d[i+1]=40; d[i+2]=40; }
        else if(currentStyle==='heat'){ d[i]=255; d[i+1]=Math.floor(60*Math.random()); d[i+2]=0; }
        else if(currentStyle==='blend'){ d[i]=d[i]+90; d[i+1]=Math.max(0,d[i+1]-40); d[i+2]=Math.max(0,d[i+2]-40); }
      } else {
        if(currentStyle==='dual'){ d[i]=Math.min(255,d[i]+40); d[i+1]=Math.min(255,d[i+1]+120); d[i+2]=Math.min(255,d[i+2]+80); }
      }
    }
  }
  ctx.putImageData(imgData,0,0);
  canvasOut.style.display='block';
  previewImg.style.display='none';
}

/* safety meter: compute contamination percentage */
function updateSafety(mask){
  const total = mask.data.length;
  const contaminated = mask.data.reduce((a,b)=>a+b,0);
  const ratio = contaminated/total;
  const pct = Math.round(ratio*100);
  // safety: 0‚Äì20 safe, 21‚Äì50 moderate, 51+ high
  const fill = Math.min(100, Math.round(pct*1.2));
  safetymeter.style.width = `${fill}%`;
}

/* save to history */
document.getElementById('saveBtn').onclick = ()=>{
  if(!lastMask) return alert('Run first');
  const c = document.createElement('canvas'); c.width=320; c.height=Math.round(320*previewImg.naturalHeight/previewImg.naturalWidth);
  c.getContext('2d').drawImage(canvasOut,0,0,c.width,c.height);
  const thumb = c.toDataURL('image/jpeg',0.8);
  const rec = {ts:new Date().toISOString(), thumb, stats:stats.innerText};
  const hist = JSON.parse(localStorage.getItem('ms_hist_v2')||'[]'); hist.unshift(rec); localStorage.setItem('ms_hist_v2', JSON.stringify(hist.slice(0,40))); renderHistory();
  alert('Saved locally');
};
function renderHistory(){ const hist = JSON.parse(localStorage.getItem('ms_hist_v2')||'[]'); if(hist.length===0){ historyDiv.innerHTML='No saved results'; return; } historyDiv.innerHTML=''; hist.forEach(h=>{ const img=document.createElement('img'); img.src=h.thumb; historyDiv.appendChild(img); }); }
renderHistory();

/* load cached tf model if user later uploads one via UI - optional */
</script>

</body>
</html>
